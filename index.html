<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MoneyFlow ‚Äî —É—á—ë—Ç –ª–∏—á–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤ (—Å Supabase)</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Supabase JS Client (UMD build via jsDelivr ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Content-Type) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

  <!-- Favicon (data URI) ‚Äî several rel types to reduce /favicon.ico 404 -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%237c3aed'/%3E%3Ctext x='50' y='58' font-size='50' text-anchor='middle' fill='white' font-family='Arial'%3EMF%3C/text%3E%3C/svg%3E">
  <link rel="shortcut icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%237c3aed'/%3E%3Ctext x='50' y='58' font-size='50' text-anchor='middle' fill='white' font-family='Arial'%3EMF%3C/text%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%237c3aed'/%3E%3C/text%3E%3C/svg%3E">

  <style>
    /* ===========================
       –¢—ë–º–Ω–∞—è –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è —Ç–µ–º–∞
       =========================== */
    :root{
      --bg: #0b0f14;
      --panel: #0f1720;
      --muted: #98a0aa;
      --accent: linear-gradient(135deg,#7c3aed,#06b6d4);
      --glass: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.02);
      --glass-3: rgba(255,255,255,0.04);
      --card-shadow: 0 6px 18px rgba(2,6,23,0.6);
      --radius: 14px;
      --radius-sm: 10px;
      --trans: 220ms cubic-bezier(.2,.9,.3,1);
      --currency: "‚ÇΩ";
    }

    html,body{ height:100%; margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:
      radial-gradient(1200px 600px at 10% 10%, rgba(124,58,237,0.06), transparent 6%),
      radial-gradient(1200px 600px at 90% 90%, rgba(6,182,212,0.04), transparent 6%),
      var(--bg);
      color:#e6eef6; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    .app{ max-width:1100px; margin:32px auto; padding:28px; display:grid; grid-template-columns: 260px 1fr; gap:20px; align-items:start; }

    /* Sidebar */
    .sidebar{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:var(--radius); padding:16px; box-shadow: var(--card-shadow); min-height:520px; position:sticky; top:20px; }
    .brand{ display:flex; gap:12px; align-items:center; margin-bottom:18px; }
    .logo{ width:44px; height:44px; border-radius:10px; background:var(--accent); display:flex; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(124,58,237,0.12); font-weight:700; }
    .brand h1{ font-size:16px; margin:0; }
    .brand p{ margin:0; color:var(--muted); font-size:12px; }

    nav ul{ list-style:none; padding:0; margin:12px 0; display:flex; flex-direction:column; gap:8px; }
    nav button{ display:flex; gap:12px; align-items:center; width:100%; background:transparent; border:0; color:inherit; padding:10px 12px; border-radius:10px; cursor:pointer; transition:all var(--trans); text-align:left; }
    nav button:hover{ background:var(--glass-2); transform:translateY(-2px); }
    nav button.active{ background:linear-gradient(90deg, rgba(124,58,237,0.12), rgba(6,182,212,0.04)); box-shadow:0 6px 18px rgba(2,6,23,0.6); }

    .sidebar .section-title{ color:var(--muted); font-size:12px; margin:14px 2px 4px; }
    .small{ font-size:12px; color:var(--muted); }

    /* Main area */
    .main{ min-height:520px; display:flex; flex-direction:column; gap:18px; }

    .summary{ display:flex; gap:16px; align-items:center; }
    .card{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:var(--radius); padding:18px; box-shadow: var(--card-shadow); }
    .summary .total{ flex:1; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .quick-actions{ display:flex; gap:10px; }
    .btn{ background: linear-gradient(90deg,#2b3141,#16181c); border:0; padding:8px 12px; border-radius:10px; cursor:pointer; color:#e6eef6; font-weight:600; box-shadow: 0 6px 18px rgba(2,6,23,0.35); transition: transform var(--trans), box-shadow var(--trans); }
    .btn:active{ transform:translateY(1px); }

    .grid{ display:grid; grid-template-columns: 380px 1fr; gap:16px; align-items:start; }

    .chart-wrap{ padding:14px; border-radius:var(--radius-sm); background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01)); }
    canvas{ display:block; max-width:100%; height:260px !important; }

    .cards-list{ display:flex; flex-direction:column; gap:12px; margin-top:6px; }
    .bank-card{ display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:12px; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); transition: transform var(--trans), box-shadow var(--trans); }
    .bank-card:hover{ transform:translateY(-4px); box-shadow: 0 14px 30px rgba(2,6,23,0.6); }
    .bank-card .meta{ display:flex; gap:12px; align-items:center; }
    .chip{ width:44px; height:44px; border-radius:10px; display:grid; place-items:center; background:linear-gradient(135deg,#1f2937,#111827); font-weight:700; color:var(--muted); }
    .small-muted{ color:var(--muted); font-size:12px; }

    .list{ display:flex; flex-direction:column; gap:8px; }
    .list-item{ display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:10px; background:var(--glass); transition:all var(--trans); }

    .form{ display:flex; flex-direction:column; gap:10px; margin-top:8px; }
    .form-row{ display:flex; gap:8px; }
    input[type="text"], input[type="number"], select, input[type="password"]{ background:transparent; border:1px solid rgba(255,255,255,0.06); padding:10px 12px; border-radius:10px; color:inherit; outline:none; flex:1; transition:border-color var(--trans); }
    input[type="text"]:focus, input[type="number"]:focus, select:focus, input[type="password"]:focus{ border-color:rgba(124,58,237,0.6); box-shadow:0 6px 18px rgba(124,58,237,0.06); }

    .payments{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .payment-row{ display:flex; gap:12px; align-items:center; justify-content:space-between; padding:10px; border-radius:10px; background:var(--glass-3); }

    .pill{ padding:6px 8px; border-radius:999px; background:rgba(255,255,255,0.03); font-size:13px; color:var(--muted); }

    .footer{ color:var(--muted); font-size:12px; margin-top:8px; }
    .muted{ color:var(--muted); font-size:13px; }

    /* Auth modal */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal{ width:380px; border-radius:12px; padding:18px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow: 0 20px 60px rgba(2,6,23,0.7); }
    .tabs{ display:flex; gap:8px; margin-bottom:12px; }
    .tabs button{ flex:1; padding:8px; border-radius:8px; border:0; background:transparent; color:var(--muted); cursor:pointer; }
    .tabs button.active{ background:rgba(124,58,237,0.12); color:#eaf2ff; }

    /* Responsive */
    @media (max-width:980px){ .app{ grid-template-columns: 1fr; padding:14px; } .summary{ flex-direction:column; } .grid{ grid-template-columns: 1fr; } .sidebar{ position:relative; top:auto; min-height:auto; } }
  </style>
</head>
<body>
  <div class="app" id="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
      <div class="brand">
        <div class="logo">MF</div>
        <div>
          <h1>MoneyFlow</h1>
          <p>–£—á—ë—Ç –ª–∏—á–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤ ‚Äî Supabase</p>
        </div>
      </div>

      <div id="user-area" style="margin-bottom:12px;"></div>

      <nav aria-label="–ú–µ–Ω—é">
        <ul>
          <li><button id="tab-dashboard" class="active" data-tab="dashboard">üè† –î—ç—à–±–æ—Ä–¥</button></li>
          <li><button id="tab-cards" data-tab="cards">üí≥ –ö–∞—Ä—Ç—ã</button></li>
          <li><button id="tab-expenses" data-tab="expenses">üßæ –†–∞—Å—Ö–æ–¥—ã</button></li>
          <li><button id="tab-categories" data-tab="categories">üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button></li>
          <li><button id="tab-payments" data-tab="payments">üìÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã</button></li>
          <li><button id="tab-incomes" data-tab="incomes">üí∞ –î–æ—Ö–æ–¥—ã</button></li>
        </ul>
      </nav>

      <div class="section-title">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
      <div style="display:flex;gap:8px;margin-top:8px; flex-wrap: wrap;">
        <button class="btn" id="quick-add-card">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É</button>
        <button class="btn" id="quick-add-expense">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
      </div>

      <div style="margin-top:18px;">
        <div class="small">–ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è: <span class="small-muted" id="last-sync">‚Äî</span></div>
        <div class="footer">–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Supabase</div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- Top summary -->
      <div class="summary">
        <div class="card total" style="min-width:320px;">
          <div class="left">
            <h2>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</h2>
            <p id="total-balance">‚Äî</p>
            <div class="muted" id="accounts-count">‚Äî –∫–∞—Ä—Ç</div>
          </div>
          <div class="quick-actions">
            <button class="btn" id="export-data" title="–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ">–≠–∫—Å–ø–æ—Ä—Ç</button>
            <button class="btn" id="import-data" title="–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JSON">–ò–º–ø–æ—Ä—Ç</button>
          </div>
        </div>

        <div style="display:flex;gap:12px; align-items:center;">
          <div class="card" style="min-width:220px;">
            <div class="muted">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</div>
            <div id="recent-list" style="margin-top:8px;"></div>
          </div>
        </div>
      </div>

      <!-- Content area (tabs) -->
      <section id="content-area">
        <!-- DASHBOARD -->
        <div id="tab-dashboard-content" class="card" role="region" tabindex="-1">
          <h3 style="margin:0 0 12px 0;">–î–∞—à–±–æ—Ä–¥</h3>
          <div class="grid">
            <div>
              <div class="chart-wrap card">
                <h4 style="margin:0 0 10px 0;">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h4>
                <canvas id="expensesChart" aria-label="–ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤"></canvas>
                <div class="muted" style="margin-top:8px;">–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—É–º–º–∞—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.</div>
              </div>

              <div style="margin-top:12px;" class="card">
                <h4 style="margin:0 0 8px 0;">–ö–∞—Ä—Ç—ã</h4>
                <div class="cards-list" id="cards-list"></div>
                <div style="margin-top:10px; display:flex; gap:8px;">
                  <button class="btn" id="show-cards-tab">–£–ø—Ä–∞–≤–ª—è—Ç—å –∫–∞—Ä—Ç–∞–º–∏</button>
                  <button class="btn" id="add-sample-data">–î–æ–±–∞–≤–∏—Ç—å demo-–¥–∞–Ω–Ω—ã–µ</button>
                </div>
              </div>
            </div>

            <div>
              <div class="card">
                <h4 style="margin:0 0 8px 0;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                <div class="list" id="stats-list"></div>
              </div>

              <div class="card" style="margin-top:12px;">
                <h4 style="margin:0 0 8px 0;">–ù–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h4>
                <div class="form">
                  <input type="number" id="quick-amount" placeholder="–°—É–º–º–∞" />
                  <select id="quick-category"></select>
                  <select id="quick-card"></select>
                  <div style="display:flex; gap:8px;">
                    <button class="btn" id="quick-add-expense-2">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
                    <button class="btn" id="quick-add-income-2">–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</button>
                  </div>
                  <div class="muted">–ë–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã –∏–∑–º–µ–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CARDS -->
        <div id="tab-cards-content" class="card" role="region" style="display:none;" tabindex="-1">
          <h3 style="margin:0 0 12px 0;">–ö–∞—Ä—Ç—ã</h3>
          <div class="grid" style="grid-template-columns:1fr 360px;">
            <div>
              <div class="list" id="cards-manage-list"></div>
            </div>
            <div>
              <div class="card">
                <h4 style="margin:0 0 8px 0;">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É</h4>
                <form id="form-add-card" class="form" onsubmit="return false;">
                  <input id="card-name" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –û—Å–Ω–æ–≤–Ω–∞—è)" required />
                  <input id="card-last4" type="text" placeholder="–ù–æ–º–µ—Ä / –ø–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã" maxlength="20" />
                  <input id="card-balance" type="number" placeholder="–ë–∞–ª–∞–Ω—Å (—á–∏—Å–ª–æ–º)" step="0.01" required />
                  <div style="display:flex; gap:8px;">
                    <button class="btn" id="save-card">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                  </div>
                  <div class="muted">–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Supabase.</div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- EXPENSES -->
        <div id="tab-expenses-content" class="card" role="region" style="display:none;" tabindex="-1">
          <h3 style="margin:0 0 12px 0;">–†–∞—Å—Ö–æ–¥—ã</h3>
          <div style="display:flex; gap:16px;">
            <div style="flex:1;">
              <div class="card">
                <h4 style="margin:0 0 8px 0;">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</h4>
                <form id="form-add-expense" class="form" onsubmit="return false;">
                  <input id="expense-amount" type="number" step="0.01" placeholder="–°—É–º–º–∞" required />
                  <select id="expense-category" required></select>
                  <select id="expense-card" required></select>
                  <input id="expense-note" type="text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
                  <div style="display:flex; gap:8px;">
                    <button class="btn" id="save-expense">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button class="btn" id="clear-expense">–û—á–∏—Å—Ç–∏—Ç—å</button>
                  </div>
                  <div class="muted">–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ ‚Äî –±–∞–ª–∞–Ω—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã —É–º–µ–Ω—å—à–∏—Ç—Å—è.</div>
                </form>
              </div>

              <div class="card" style="margin-top:12px;">
                <h4 style="margin:0 0 8px 0;">–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤</h4>
                <div id="expenses-list" class="list"></div>
              </div>
            </div>

            <div style="width:360px;">
              <div class="card">
                <h4 style="margin:0 0 8px 0;">–§–∏–ª—å—Ç—Ä—ã</h4>
                <div class="form">
                  <select id="filter-card">
                    <option value="">–ü–æ –≤—Å–µ–º –∫–∞—Ä—Ç–∞–º</option>
                  </select>
                  <select id="filter-category">
                    <option value="">–ü–æ –≤—Å–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</option>
                  </select>
                  <div style="display:flex; gap:8px;">
                    <button class="btn" id="apply-filters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    <button class="btn" id="reset-filters">–°–±—Ä–æ—Å</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CATEGORIES -->
        <div id="tab-categories-content" class="card" role="region" style="display:none;" tabindex="-1">
          <h3 style="margin:0 0 12px 0;">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
          <div style="display:flex; gap:16px;">
            <div style="flex:1;">
              <div class="card">
                <h4 style="margin:0 0 8px 0;">–°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h4>
                <div id="categories-list" class="list"></div>
              </div>
            </div>
            <div style="width:360px;">
              <div class="card">
                <h4 style="margin:0 0 8px 0;">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h4>
                <form id="form-add-category" class="form" onsubmit="return false;">
                  <input id="category-name" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" required />
                  <div style="display:flex; gap:8px;">
                    <button class="btn" id="save-category">–î–æ–±–∞–≤–∏—Ç—å</button>
                  </div>
                  <div class="muted">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Ä–∞—Å—Ö–æ–¥–∞—Ö –∏ –≥—Ä–∞—Ñ–∏–∫–∞—Ö.</div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- PAYMENTS -->
        <div id="tab-payments-content" class="card" role="region" style="display:none;" tabindex="-1">
          <h3 style="margin:0 0 12px 0;">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –µ–∂–µ–º–µ—Å—è—á–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏</h3>
          <div style="display:flex; gap:16px;">
            <div style="flex:1;">
              <div class="payments" id="payments-list"></div>
            </div>
            <div style="width:360px;">
              <div class="card">
                <h4 style="margin:0 0 8px 0;">–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂</h4>
                <form id="form-add-payment" class="form" onsubmit="return false;">
                  <input id="payment-name" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä. –ò–Ω—Ç–µ—Ä–Ω–µ—Ç)" required />
                  <input id="payment-amount" type="number" step="0.01" placeholder="–°—É–º–º–∞" required />
                  <select id="payment-card" required></select>
                  <div style="display:flex; gap:8px;">
                    <button class="btn" id="save-payment">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button class="btn" id="clear-payment">–û—á–∏—Å—Ç–∏—Ç—å</button>
                  </div>
                  <div class="muted">–û—Ç–º–µ—Ç—å —á–µ–∫–±–æ–∫—Å, —á—Ç–æ–±—ã —Å–ø–∏—Å–∞—Ç—å –ø–ª–∞—Ç—ë–∂ —Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã.</div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- INCOMES -->
        <div id="tab-incomes-content" class="card" role="region" style="display:none;" tabindex="-1">
          <h3 style="margin:0 0 12px 0;">–î–æ—Ö–æ–¥—ã</h3>
          <div style="display:flex; gap:16px;">
            <div style="flex:1;">
              <div class="card">
                <h4 style="margin:0 0 8px 0;">–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</h4>
                <form id="form-add-income" class="form" onsubmit="return false;">
                  <input id="income-amount" type="number" step="0.01" placeholder="–°—É–º–º–∞" required />
                  <select id="income-category" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                  </select>
                  <select id="income-card" required></select>
                  <input id="income-note" type="text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
                  <div style="display:flex; gap:8px;">
                    <button class="btn" id="save-income">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button class="btn" id="clear-income">–û—á–∏—Å—Ç–∏—Ç—å</button>
                  </div>
                  <div class="muted">–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ ‚Äî –±–∞–ª–∞–Ω—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã —É–≤–µ–ª–∏—á–∏—Ç—Å—è.</div>
                </form>
              </div>

              <div class="card" style="margin-top:12px;">
                <h4 style="margin:0 0 8px 0;">–ò—Å—Ç–æ—Ä–∏—è –¥–æ—Ö–æ–¥–æ–≤</h4>
                <div id="incomes-list" class="list"></div>
              </div>
            </div>

            <div style="width:360px;">
              <div class="card">
                <h4 style="margin:0 0 8px 0;">–§–∏–ª—å—Ç—Ä—ã</h4>
                <div class="form">
                  <select id="filter-income-card">
                    <option value="">–ü–æ –≤—Å–µ–º –∫–∞—Ä—Ç–∞–º</option>
                  </select>
                  <select id="filter-income-category">
                    <option value="">–ü–æ –≤—Å–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</option>
                  </select>
                  <div style="display:flex; gap:8px;">
                    <button class="btn" id="apply-income-filters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    <button class="btn" id="reset-income-filters">–°–±—Ä–æ—Å</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

      </section>
    </main>
  </div>

  <!-- AUTH MODAL -->
  <div class="overlay" id="auth-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="auth-title">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 id="auth-title" style="margin:0;">–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h3>
        <button class="btn" id="close-auth">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="tabs" style="margin-top:12px;">
        <button id="tab-auth-login" class="active">–í—Ö–æ–¥</button>
        <button id="tab-auth-signup">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>

      <!-- LOGIN FORM -->
      <div id="auth-login">
        <form id="form-login" class="form" onsubmit="return false;">
          <input id="login-email" type="email" placeholder="Email" required />
          <input id="login-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required />
          <div style="display:flex;gap:8px;">
            <button class="btn" id="btn-login">–í–æ–π—Ç–∏</button>
            <button class="btn" id="btn-login-guest" title="–í–æ–π—Ç–∏ –∫–∞–∫ –≥–æ—Å—Ç—å">–ì–æ—Å—Ç—å (demo)</button>
          </div>
          <div id="auth-warning" class="muted" style="margin-top:8px;">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è Supabase.</div>
        </form>
      </div>

      <!-- SIGNUP FORM -->
      <div id="auth-signup" style="display:none;">
        <form id="form-signup" class="form" onsubmit="return false;">
          <input id="signup-email" type="email" placeholder="Email" required />
          <input id="signup-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)" required />
          <input id="signup-password2" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required />
          <div style="display:flex;gap:8px;">
            <button class="btn" id="btn-signup">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            <button class="btn" id="btn-cancel-signup">–û—Ç–º–µ–Ω–∞</button>
          </div>
          <div class="muted">–ê–∫–∫–∞—É–Ω—Ç –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Supabase.</div>
        </form>
      </div>
    </div>
  </div>

  <script>
   /**************************************************************************
 * Supabase integration ‚Äî replaces local accounts/localStorage
 **************************************************************************/

// ===== CONFIG =====
const SUPABASE_URL = "https://tzsqgwupguttgsuhbknb.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_nB-DBmdfeDkjqPLQeuSxrw_mE-p30aO";

// –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º supabase ‚Äî –µ—Å–ª–∏ CDN –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è, –Ω–µ –ª–æ–º–∞–µ–º UI
const createClient = window.supabase?.createClient || (window.Supabase && window.Supabase.createClient);
const supabaseClient = createClient ? createClient(SUPABASE_URL, SUPABASE_ANON_KEY) : null;
const isSupabaseReady = Boolean(supabaseClient);

// ===== State/UI =====
let currentUser = null;
let state = { 
  cards: [], 
  categories: [], 
  expenses: [], 
  payments: [], 
  incomes: []  // ‚Üê –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –¥–æ—Ö–æ–¥–æ–≤
};
let subscriptions = [];
let isProcessing = false;

// –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–≤–∞–µ–º—ã—Ö –∫–Ω–æ–ø–æ–∫ –≤—Ö–æ–¥–∞/—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
document.addEventListener('click', (e) => {
  const t = e.target;
  if (t && t.matches && t.matches('#btn-open-login')) { openAuthModal('login'); }
  if (t && t.matches && t.matches('#btn-open-signup')) { openAuthModal('signup'); }
});

// Utils
function uid(prefix = 'id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }
function escapeHtml(text){ if (!text) return ''; return String(text).replace(/[&<>"']/g, (s) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
const CURRENCY_SYMBOL = '‚ÇΩ';
function fmt(v){ if (typeof v !== 'number') v = Number(v) || 0; return v.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2}) + ' ' + CURRENCY_SYMBOL; }
function randomColor(){ const h = Math.floor(Math.random()*360); return `hsl(${h} 70% 45%)`; }

// Demo dataset for quick population
const demo = {
  cards: [
    { name: '–û—Å–Ω–æ–≤–Ω–∞—è', last4: '1234', balance: 250000, color: '#7c3aed' },
    { name: '–°–±–µ—Ä–µ–∂–µ–Ω–∏—è', last4: '9876', balance: 1000000, color: '#06b6d4' }
  ],
  categories: [
    { name: '–ó–∞—Ä–ø–ª–∞—Ç–∞' },
    { name: '–§—Ä–∏–ª–∞–Ω—Å' },
    { name: '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏' },
    { name: '–ü–æ–¥–∞—Ä–∫–∏' },
    { name: '–ï–¥–∞' },
    { name: '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç' },
    { name: '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è' },
    { name: '–ö–æ–º–º—É–Ω–∞–ª–∫–∞' }
  ],
  expenses: [],
  incomes: [],
  payments: []
};

// ===== AUTH =====
async function signup(){
  if (isProcessing) return;
  isProcessing = true;
  
  const authWarningEl = document.getElementById('auth-warning');
  if (!supabaseClient) {
    if (authWarningEl) authWarningEl.textContent = 'Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞.';
    isProcessing = false;
    return;
  }
  
  try {
    const email = document.getElementById('signup-email').value.trim();
    const password = document.getElementById('signup-password').value;
    const password2 = document.getElementById('signup-password2').value;
    
    if (!email || !password) {
      alert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è');
      isProcessing = false;
      return;
    }
    if (password !== password2) {
      alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
      isProcessing = false;
      return;
    }
    if (password.length < 6) {
      alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
      isProcessing = false;
      return;
    }
    
    const { data, error } = await supabaseClient.auth.signUp({ email, password });
    if (error) throw error;
    
    alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ).');
    closeAuthModal();
  } catch(err) {
    console.error('signup error', err);
    if (authWarningEl) authWarningEl.textContent = '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + (err.message || err);
  } finally {
    isProcessing = false;
  }
}

async function login(){
  if (isProcessing) return;
  isProcessing = true;
  
  const authWarningEl = document.getElementById('auth-warning');
  if (!supabaseClient) {
    if (authWarningEl) authWarningEl.textContent = 'Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –≤—Ö–æ–¥ –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω.';
    isProcessing = false;
    return;
  }
  
  try {
    const email = document.getElementById('login-email').value.trim();
    const password = document.getElementById('login-password').value;
    if (!email || !password) {
      alert('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å–µ –ø–æ–ª—è');
      isProcessing = false;
      return;
    }
    
    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
    if (error) throw error;
    
    closeAuthModal();
  } catch(err) {
    console.error('login error', err);
    if (authWarningEl) authWarningEl.textContent = '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (err.message || err);
  } finally {
    isProcessing = false;
  }
}

async function logout(){
  if (!confirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?')) return;
  
  try {
    const { error } = await supabaseClient.auth.signOut();
    if (error) throw error;
    
    // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è –æ—Ç –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
    unsubscribeAll();
  } catch(err) {
    console.error('logout error', err);
    alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + err.message);
  }
}

// –û—Ç–ø–∏—Å–∫–∞ –æ—Ç –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤
function unsubscribeAll() {
  if (!supabaseClient || !subscriptions.length) return;
  
  subscriptions.forEach(ch => {
    try {
      supabaseClient.removeChannel(ch);
    } catch (e) {
      console.warn('Error removing channel:', e);
    }
  });
  subscriptions = [];
}

// Listen auth changes
if (supabaseClient && supabaseClient.auth && typeof supabaseClient.auth.onAuthStateChange === 'function') {
  supabaseClient.auth.onAuthStateChange((event, session) => {
    currentUser = session?.user || null;
    renderUserArea();
    
    if (currentUser) {
      loadDataFromSupabase().then(() => {
        renderAll();
        subscribeToUpdates();
      });
    } else {
      state = { cards: [], categories: [], expenses: [], payments: [], incomes: [] };
      unsubscribeAll();
      renderAll();
    }
  });
} else {
  // fallback: no supabase
  currentUser = null;
  renderUserArea();
}

// ===== DB helpers =====
async function loadDataFromSupabase(){
  if (!supabaseClient || !currentUser) return;
  
  try {
    const userId = currentUser.id;
    const [cardsRes, categoriesRes, expensesRes, incomesRes, paymentsRes] = await Promise.all([
      supabaseClient.from('cards').select('*').eq('user_id', userId),
      supabaseClient.from('categories').select('*').eq('user_id', userId),
      supabaseClient.from('expenses').select('*').eq('user_id', userId),
      supabaseClient.from('incomes').select('*').eq('user_id', userId),  // ‚Üê –¥–æ–±–∞–≤–ª–µ–Ω–æ
      supabaseClient.from('payments').select('*').eq('user_id', userId)
    ]);
    
    state.cards = (cardsRes.data || []).map(r => ({ ...r }));
    state.categories = (categoriesRes.data || []).map(r => ({ ...r }));
    state.expenses = (expensesRes.data || []).map(r => ({ ...r }));
    state.incomes = (incomesRes.data || []).map(r => ({ ...r }));  // ‚Üê –¥–æ–±–∞–≤–ª–µ–Ω–æ
    state.payments = (paymentsRes.data || []).map(r => ({ ...r }));
    
    document.getElementById('last-sync').textContent = new Date().toLocaleString();
  } catch (e) {
    console.error('load error', e);
  }
}

function subscribeToUpdates(){
  if (!supabaseClient || !currentUser) return;
  
  unsubscribeAll();
  
  ['cards','categories','expenses','payments','incomes'].forEach(table => {  // ‚Üê –¥–æ–±–∞–≤–ª–µ–Ω–æ incomes
    const ch = supabaseClient
      .channel(`${table}-changes-${Date.now()}`)
      .on('postgres_changes', { 
        event: '*', 
        schema: 'public', 
        table,
        filter: `user_id=eq.${currentUser.id}`
      }, payload => {
        setTimeout(() => {
          loadDataFromSupabase().then(() => renderAll());
        }, 100);
      })
      .subscribe((status) => {
        console.log(`Subscription to ${table}:`, status);
      });
    
    subscriptions.push(ch);
  });
}

async function dbInsert(table, data){
  if (!supabaseClient || !currentUser) throw new Error('No supabase or user');
  
  const payload = { ...data, user_id: currentUser.id };
  const { data: res, error } = await supabaseClient.from(table).insert([payload]).select().single();
  
  if (error) { 
    console.error('DB insert error:', error);
    throw error; 
  }
  
  return res;
}

async function dbUpdate(table, id, data){
  if (!supabaseClient || !currentUser) throw new Error('No supabase or user');
  
  const { error } = await supabaseClient.from(table).update(data).eq('id', id).eq('user_id', currentUser.id);
  
  if (error) { 
    console.error('DB update error:', error);
    throw error; 
  }
}

async function dbDelete(table, id){
  if (!supabaseClient || !currentUser) throw new Error('No supabase or user');
  
  const { error } = await supabaseClient.from(table).delete().eq('id', id).eq('user_id', currentUser.id);
  
  if (error) { 
    console.error('DB delete error:', error);
    throw error; 
  }
}

// ===== AUTH MODAL UI =====
const authOverlay = document.getElementById('auth-overlay');
function openAuthModal(defaultTab = 'login'){
  authOverlay.style.display = 'flex';
  authOverlay.setAttribute('aria-hidden','false');
  
  const loginTab = document.getElementById('tab-auth-login');
  const signupTab = document.getElementById('tab-auth-signup');
  const loginPane = document.getElementById('auth-login');
  const signupPane = document.getElementById('auth-signup');
  
  if (defaultTab === 'signup'){
    loginTab.classList.remove('active'); 
    signupTab.classList.add('active');
    loginPane.style.display='none'; 
    signupPane.style.display='block';
  } else {
    loginTab.classList.add('active'); 
    signupTab.classList.remove('active');
    loginPane.style.display='block'; 
    signupPane.style.display='none';
  }
  
  document.getElementById('login-email')?.focus();
}

function closeAuthModal(){
  authOverlay.style.display = 'none';
  authOverlay.setAttribute('aria-hidden','true');
  
  ['login-email','login-password','signup-email','signup-password','signup-password2'].forEach(id => {
    const el = document.getElementById(id); 
    if(el) el.value = '';
  });
}

document.getElementById('tab-auth-login').addEventListener('click', () => openAuthModal('login'));
document.getElementById('tab-auth-signup').addEventListener('click', () => openAuthModal('signup'));
document.getElementById('close-auth').addEventListener('click', closeAuthModal);
document.getElementById('btn-cancel-signup').addEventListener('click', closeAuthModal);
document.getElementById('btn-signup').addEventListener('click', signup);
document.getElementById('btn-login').addEventListener('click', login);

// ===== USER AREA =====
function renderUserArea(){
  const area = document.getElementById('user-area');
  area.innerHTML = '';
  
  if (currentUser){
    const userDiv = document.createElement('div');
    userDiv.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
        <div>
          <div style="font-weight:700">${escapeHtml(currentUser.email)}</div>
          <div class="small-muted">–≤–æ—à—ë–ª</div>
        </div>
        <button class="btn" id="btn-logout-small" style="padding:6px 8px;font-size:13px;">–í—ã–π—Ç–∏</button>
      </div>
    `;
    area.appendChild(userDiv);
    document.getElementById('btn-logout-small').addEventListener('click', logout);
  } else {
    const guestDiv = document.createElement('div');
    guestDiv.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:8px;">
        <div style="font-weight:700">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>
        <div style="display:flex;gap:8px;margin-top:8px;">
          <button class="btn" id="btn-open-login">–í–æ–π—Ç–∏</button>
          <button class="btn" id="btn-open-signup">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
      </div>
    `;
    area.appendChild(guestDiv);
  }
}

// ===== RENDER / UI =====
let expensesChart = null;
function renderChart(){
  const ctx = document.getElementById('expensesChart').getContext('2d');
  const sums = {};
  
  state.expenses.forEach(e => {
    const cat = state.categories.find(c => c.id === e.category_id);
    const catName = cat ? cat.name : '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
    sums[catName] = (sums[catName] || 0) + Number(e.amount || 0);
  });
  
  const labels = Object.keys(sums);
  const data = labels.map(l => sums[l]);
  const palette = labels.map((_, i) => `hsla(${(i * 47) % 360} 70% 60% / 0.95)`);
  
  if (expensesChart) expensesChart.destroy();
  
  expensesChart = new Chart(ctx, {
    type: 'pie',
    data: { 
      labels, 
      datasets: [{ 
        data, 
        backgroundColor: palette, 
        hoverOffset: 8, 
        borderWidth: 0 
      }] 
    },
    options: {
      plugins: { 
        legend: { 
          position: 'bottom', 
          labels: { color: '#cfd8e3' } 
        }, 
        tooltip: { 
          callbacks: { 
            label: (ctx) => ctx.label + ': ' + fmt(ctx.raw || 0) 
          } 
        } 
      },
      maintainAspectRatio: false
    }
  });
}

function computeTotalBalance(){ 
  return state.cards.reduce((s, c) => s + Number(c.balance || 0), 0); 
}

function renderSummary(){ 
  const total = computeTotalBalance();
  const totalExpenses = state.expenses.reduce((sum, e) => sum + Number(e.amount || 0), 0);
  const totalIncomes = state.incomes.reduce((sum, i) => sum + Number(i.amount || 0), 0);
  
  document.getElementById('total-balance').textContent = fmt(total); 
  document.getElementById('accounts-count').textContent = `${state.cards.length} –∫–∞—Ä—Ç, ${state.expenses.length} —Ä–∞—Å—Ö–æ–¥–æ–≤, ${state.incomes.length} –¥–æ—Ö–æ–¥–æ–≤`;
}

function renderCardsList(){
  const container = document.getElementById('cards-list'); 
  container.innerHTML = '';
  
  state.cards.forEach(c => {
    const el = document.createElement('div'); 
    el.className = 'bank-card';
    el.innerHTML = `
      <div class="meta">
        <div class="chip" style="background:linear-gradient(135deg, ${c.color || '#2b3141'}, rgba(0,0,0,0.1));">
          ${(c.name || '').slice(0, 2).toUpperCase()}
        </div>
        <div>
          <div style="font-weight:600">${escapeHtml(c.name)}</div>
          <div class="small-muted">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${escapeHtml(c.last4 || '')}</div>
        </div>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700">${fmt(Number(c.balance || 0))}</div>
        <div class="small-muted">–ë–∞–ª–∞–Ω—Å</div>
      </div>
    `;
    container.appendChild(el);
  });

  const manage = document.getElementById('cards-manage-list'); 
  manage.innerHTML = '';
  
  state.cards.forEach(c => {
    const item = document.createElement('div'); 
    item.className = 'list-item';
    item.innerHTML = `
      <div>
        <div style="font-weight:600">${escapeHtml(c.name)}</div>
        <div class="small-muted">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${escapeHtml(c.last4)}</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <div class="pill">${fmt(Number(c.balance || 0))}</div>
        <button class="btn small" data-id="${c.id}" data-action="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn small" data-id="${c.id}" data-action="delete">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;
    manage.appendChild(item);
  });

  manage.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (isProcessing) return;
      isProcessing = true;
      
      try {
        const id = btn.dataset.id; 
        const action = btn.dataset.action;
        
        if (action === 'delete'){
          if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç—É?')) {
            isProcessing = false;
            return;
          }
          
          await dbDelete('cards', id);
          await loadDataFromSupabase(); 
          renderAll();
        } else if (action === 'edit'){
          const card = state.cards.find(x => x.id === id); 
          if (!card) return;
          
          document.getElementById('card-name').value = card.name;
          document.getElementById('card-last4').value = card.last4;
          document.getElementById('card-balance').value = Number(card.balance || 0);
          document.getElementById('save-card').dataset.editId = id;
          showTab('cards');
        }
      } catch (err) {
        console.error('Error in card action:', err);
        alert('–û—à–∏–±–∫–∞: ' + err.message);
      } finally {
        isProcessing = false;
      }
    });
  });
}

function renderRecentExpenses(){
  const container = document.getElementById('recent-list'); 
  container.innerHTML = '';
  
  // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–∞—Å—Ö–æ–¥—ã –∏ –¥–æ—Ö–æ–¥—ã –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  const allTransactions = [
    ...state.expenses.map(e => ({ ...e, type: 'expense' })),
    ...state.incomes.map(i => ({ ...i, type: 'income' }))
  ].sort((a,b) => new Date(b.created_at) - new Date(a.created_at)).slice(0,5);
    
  if (allTransactions.length === 0) { 
    container.innerHTML = '<div class="small-muted">–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>'; 
    return; 
  }
  
  allTransactions.forEach(transaction => {
    const cat = state.categories.find(c => c.id === transaction.category_id);
    const card = state.cards.find(c => c.id === transaction.card_id);
    const el = document.createElement('div'); 
    el.style.display='flex'; 
    el.style.justifyContent='space-between'; 
    el.style.padding='6px 0';
    
    const sign = transaction.type === 'income' ? '+' : '-';
    const color = transaction.type === 'income' ? '#10b981' : '#ef4444';
    
    el.innerHTML = `
      <div>
        <div style="font-weight:600">${escapeHtml(transaction.note || (cat ? cat.name : transaction.type === 'income' ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'))}</div>
        <div class="small-muted">${cat ? escapeHtml(cat.name) : '‚Äî'} ‚Ä¢ ${card ? escapeHtml(card.name) : '‚Äî'}</div>
      </div>
      <div style="text-align:right; color: ${color}; font-weight:700">${sign}${fmt(Number(transaction.amount || 0))}</div>
    `;
    container.appendChild(el);
  });
}

function renderStats(){
  const container = document.getElementById('stats-list'); 
  container.innerHTML = '';
  
  const totalExpenses = state.expenses.reduce((sum, e) => sum + Number(e.amount || 0), 0);
  const totalIncomes = state.incomes.reduce((sum, i) => sum + Number(i.amount || 0), 0);
  const balance = totalIncomes - totalExpenses;
  
  const stats = [
    { label: '–í—Å–µ–≥–æ –¥–æ—Ö–æ–¥–æ–≤', value: fmt(totalIncomes), color: '#10b981' },
    { label: '–í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤', value: fmt(totalExpenses), color: '#ef4444' },
    { label: '–ë–∞–ª–∞–Ω—Å –æ–ø–µ—Ä–∞—Ü–∏–π', value: fmt(balance), color: balance >= 0 ? '#10b981' : '#ef4444' },
    { label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–ø–µ—Ä–∞—Ü–∏–π', value: state.expenses.length + state.incomes.length, color: '#6366f1' }
  ];
  
  stats.forEach(stat => { 
    const row = document.createElement('div'); 
    row.className='list-item'; 
    row.innerHTML = `
      <div>${stat.label}</div>
      <div style="font-weight:700; color: ${stat.color}">${stat.value}</div>
    `; 
    container.appendChild(row); 
  });
}

let currentFilters = { card_id:'', category_id:'' };

function renderExpensesList(){
  const container = document.getElementById('expenses-list'); 
  container.innerHTML = '';
  
  let list = state.expenses.slice().sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
  
  if (currentFilters.card_id) list = list.filter(e => e.card_id === currentFilters.card_id);
  if (currentFilters.category_id) list = list.filter(e => e.category_id === currentFilters.category_id);
  
  if (list.length === 0) { 
    container.innerHTML = '<div class="small-muted">–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤</div>'; 
    return; 
  }
  
  list.forEach(e => {
    const cat = state.categories.find(c => c.id === e.category_id);
    const card = state.cards.find(c => c.id === e.card_id);
    const item = document.createElement('div'); 
    item.className='list-item';
    item.innerHTML = `
      <div>
        <div style="font-weight:600">${escapeHtml(e.note || (cat ? cat.name : '–†–∞—Å—Ö–æ–¥'))}</div>
        <div class="small-muted">${cat ? escapeHtml(cat.name) : '‚Äî'} ‚Ä¢ ${new Date(e.created_at).toLocaleString()}</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <div style="font-weight:700; color: #ef4444">-${fmt(Number(e.amount||0))}</div>
        <div class="small-muted">${card ? escapeHtml(card.name) : '‚Äî'}</div>
        <button class="btn small" data-id="${e.id}" data-action="del-exp">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;
    container.appendChild(item);
  });

  container.querySelectorAll('button').forEach(b => {
    b.addEventListener('click', async () => { 
      if (isProcessing) return;
      isProcessing = true;
      
      try {
        const id = b.dataset.id; 
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ–ø–µ—Ä–∞—Ü–∏—é?')) {
          isProcessing = false;
          return;
        }
        
        await dbDelete('expenses', id);
        await loadDataFromSupabase(); 
        renderAll();
      } catch (err) {
        console.error('Error deleting expense:', err);
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + err.message);
      } finally {
        isProcessing = false;
      }
    });
  });
}

let currentIncomeFilters = { card_id:'', category_id:'' };

function renderIncomesList(){
  const container = document.getElementById('incomes-list'); 
  container.innerHTML = '';
  
  let list = state.incomes.slice().sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
  
  if (currentIncomeFilters.card_id) list = list.filter(e => e.card_id === currentIncomeFilters.card_id);
  if (currentIncomeFilters.category_id) list = list.filter(e => e.category_id === currentIncomeFilters.category_id);
  
  if (list.length === 0) { 
    container.innerHTML = '<div class="small-muted">–ù–µ—Ç –¥–æ—Ö–æ–¥–æ–≤</div>'; 
    return; 
  }
  
  list.forEach(e => {
    const cat = state.categories.find(c => c.id === e.category_id);
    const card = state.cards.find(c => c.id === e.card_id);
    const item = document.createElement('div'); 
    item.className='list-item';
    item.innerHTML = `
      <div>
        <div style="font-weight:600">${escapeHtml(e.note || (cat ? cat.name : '–î–æ—Ö–æ–¥'))}</div>
        <div class="small-muted">${cat ? escapeHtml(cat.name) : '‚Äî'} ‚Ä¢ ${new Date(e.created_at).toLocaleString()}</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <div style="font-weight:700; color: #10b981">+${fmt(Number(e.amount||0))}</div>
        <div class="small-muted">${card ? escapeHtml(card.name) : '‚Äî'}</div>
        <button class="btn small" data-id="${e.id}" data-action="del-inc">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;
    container.appendChild(item);
  });

  container.querySelectorAll('button').forEach(b => {
    b.addEventListener('click', async () => { 
      if (isProcessing) return;
      isProcessing = true;
      
      try {
        const id = b.dataset.id; 
        if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –¥–æ—Ö–æ–¥?')) {
          isProcessing = false;
          return;
        }
        
        await dbDelete('incomes', id);
        await loadDataFromSupabase(); 
        renderAll();
      } catch (err) {
        console.error('Error deleting income:', err);
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + err.message);
      } finally {
        isProcessing = false;
      }
    });
  });
}

function renderCategories(){
  const container = document.getElementById('categories-list'); 
  container.innerHTML = '';
  
  if (!state.categories || state.categories.length === 0){ 
    container.innerHTML = '<div class="small-muted">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>'; 
    return; 
  }
  
  state.categories.forEach(c => {
    // –°—á–∏—Ç–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≤ —Ä–∞—Å—Ö–æ–¥–∞—Ö –∏ –¥–æ—Ö–æ–¥–∞—Ö
    const expenseCount = state.expenses.filter(e => e.category_id === c.id).length;
    const incomeCount = state.incomes.filter(i => i.category_id === c.id).length;
    const totalUsage = expenseCount + incomeCount;
    
    const item = document.createElement('div'); 
    item.className='list-item';
    item.innerHTML = `
      <div style="display:flex; gap:10px; align-items:center;">
        <div>
          <div style="font-weight:600">${escapeHtml(c.name)}</div>
          <div class="small-muted">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π: ${totalUsage}</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn small" data-id="${c.id}" data-action="delete">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;
    container.appendChild(item);
  });

  container.querySelectorAll('button').forEach(b => {
    b.addEventListener('click', async () => {
      if (isProcessing) return;
      isProcessing = true;
      
      try {
        const id = b.dataset.id;
        if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é?')) {
          isProcessing = false;
          return;
        }
        
        await dbDelete('categories', id);
        await loadDataFromSupabase(); 
        renderAll();
      } catch (err) {
        console.error('Error deleting category:', err);
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + err.message);
      } finally {
        isProcessing = false;
      }
    });
  });
}

function renderPayments(){
  const container = document.getElementById('payments-list'); 
  container.innerHTML = '';
  
  if (!state.payments || state.payments.length === 0){ 
    container.innerHTML = '<div class="small-muted">–ù–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π</div>'; 
    return; 
  }
  
  state.payments.forEach(p => {
    const card = state.cards.find(c => c.id === p.card_id);
    const row = document.createElement('div'); 
    row.className='payment-row';
    row.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center;">
        <input type="checkbox" ${p.paid ? 'checked' : ''} data-id="${p.id}" />
        <div>
          <div style="font-weight:600">${escapeHtml(p.name)}</div>
          <div class="small-muted">${card ? escapeHtml(card.name) : '–ö–∞—Ä—Ç—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ'}</div>
        </div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div style="font-weight:700">${fmt(Number(p.amount || 0))}</div>
        <button class="btn small" data-id="${p.id}" data-action="del-pay">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    `;
    container.appendChild(row);

    const checkbox = row.querySelector('input[type="checkbox"]');
    checkbox.addEventListener('change', async () => {
      if (isProcessing) return;
      isProcessing = true;
      
      try {
        const newPaid = checkbox.checked;
        await dbUpdate('payments', p.id, { paid: newPaid });
        await loadDataFromSupabase(); 
        renderAll();
      } catch (err) {
        console.error('Error updating payment:', err);
        alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞: ' + err.message);
        checkbox.checked = !checkbox.checked; // –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —á–µ–∫–±–æ–∫—Å –ø—Ä–∏ –æ—à–∏–±–∫–µ
      } finally {
        isProcessing = false;
      }
    });

    row.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (isProcessing) return;
        isProcessing = true;
        
        try {
          const id = btn.dataset.id;
          if (!confirm('–£–¥–∞–ª–∏—Ç—å –ø–ª–∞—Ç—ë–∂?')) {
            isProcessing = false;
            return;
          }
          
          await dbDelete('payments', id);
          await loadDataFromSupabase(); 
          renderAll();
        } catch (err) {
          console.error('Error deleting payment:', err);
          alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + err.message);
        } finally {
          isProcessing = false;
        }
      });
    });
  });
}

function populateSelects(){
  const selectsCat = ['expense-category','quick-category','filter-category','income-category','filter-income-category'];
  selectsCat.forEach(id => {
    const el = document.getElementById(id); 
    if (!el) return; 
    el.innerHTML = '';
    
    if (id === 'filter-category' || id === 'filter-income-category'){ 
      const opt = document.createElement('option'); 
      opt.value=''; 
      opt.textContent='–ü–æ –≤—Å–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º'; 
      el.appendChild(opt); 
    }
    
    if (id === 'income-category' || id === 'expense-category') {
      const optDefault = document.createElement('option');
      optDefault.value = '';
      optDefault.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
      el.appendChild(optDefault);
    }
    
    state.categories.forEach(c => { 
      const opt = document.createElement('option'); 
      opt.value = c.id; 
      opt.textContent = c.name; 
      el.appendChild(opt); 
    });
  });
  
  const selectsCard = ['expense-card','quick-card','filter-card','payment-card','income-card','filter-income-card'];
  selectsCard.forEach(id => {
    const el = document.getElementById(id); 
    if (!el) return; 
    el.innerHTML = '';
    
    if (id === 'filter-card' || id === 'filter-income-card'){ 
      const opt = document.createElement('option'); 
      opt.value=''; 
      opt.textContent='–ü–æ –≤—Å–µ–º –∫–∞—Ä—Ç–∞–º'; 
      el.appendChild(opt); 
    }
    
    if (id === 'income-card' || id === 'expense-card' || id === 'payment-card') {
      const optDefault = document.createElement('option');
      optDefault.value = '';
      optDefault.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É';
      el.appendChild(optDefault);
    }
    
    state.cards.forEach(c => { 
      const opt = document.createElement('option'); 
      opt.value=c.id; 
      opt.textContent=`${c.name} ‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${c.last4} (${fmt(Number(c.balance||0))})`; 
      el.appendChild(opt); 
    });
  });
}

// ===== FORM HANDLERS =====

// Cards
document.getElementById('form-add-card').addEventListener('submit', (e) => {
  e.preventDefault();
  document.getElementById('save-card').click();
});

document.getElementById('save-card').addEventListener('click', async () => {
  if (isProcessing) return;
  isProcessing = true;
  
  try {
    if (!currentUser) {
      openAuthModal('login');
      isProcessing = false;
      return;
    }
    
    const editId = document.getElementById('save-card').dataset.editId;
    const name = document.getElementById('card-name').value.trim();
    const last4 = document.getElementById('card-last4').value.trim();
    const bal = Number(document.getElementById('card-balance').value) || 0;
    
    if (!name) {
      alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã');
      isProcessing = false;
      return;
    }
    
    if (editId) {
      await dbUpdate('cards', editId, { name, last4, balance: bal });
      delete document.getElementById('save-card').dataset.editId;
      await loadDataFromSupabase(); 
      renderAll(); 
      alert('–ö–∞—Ä—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
    } else {
      await dbInsert('cards', { name, last4, balance: bal, color: randomColor() });
      await loadDataFromSupabase(); 
      renderAll();
      document.getElementById('card-name').value=''; 
      document.getElementById('card-last4').value=''; 
      document.getElementById('card-balance').value='';
    }
  } catch (err) {
    console.error('Error saving card:', err);
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã: ' + err.message);
  } finally {
    isProcessing = false;
  }
});

// Expenses
document.getElementById('form-add-expense').addEventListener('submit', (e) => {
  e.preventDefault();
  document.getElementById('save-expense').click();
});

document.getElementById('save-expense').addEventListener('click', async () => {
  if (isProcessing) return;
  isProcessing = true;
  
  try {
    if (!currentUser) {
      openAuthModal('login');
      isProcessing = false;
      return;
    }
    
    const amount = Number(document.getElementById('expense-amount').value) || 0;
    const category_id = document.getElementById('expense-category').value || null;
    const card_id = document.getElementById('expense-card').value || null;
    const note = document.getElementById('expense-note').value.trim();
    
    if (!amount || !card_id || !category_id) {
      alert('–£–∫–∞–∂–∏ —Å—É–º–º—É, –∫–∞—Ä—Ç—É –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
      isProcessing = false;
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –∫–∞—Ä—Ç–µ
    const card = state.cards.find(c => c.id === card_id);
    if (card && amount > Number(card.balance || 0)) {
      if (!confirm(`–ù–∞ –∫–∞—Ä—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ë–∞–ª–∞–Ω—Å: ${fmt(card.balance)}. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) {
        isProcessing = false;
        return;
      }
    }
    
    // –ë–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    await dbInsert('expenses', { 
      amount, 
      category_id, 
      card_id, 
      note, 
      created_at: new Date().toISOString() 
    });
    
    await loadDataFromSupabase(); 
    renderAll();
    document.getElementById('expense-amount').value=''; 
    document.getElementById('expense-note').value=''; 
    alert('–†–∞—Å—Ö–æ–¥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
  } catch (err) {
    console.error('Error saving expense:', err);
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å—Ö–æ–¥–∞: ' + err.message);
  } finally {
    isProcessing = false;
  }
});

// Quick expense (–Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ)
document.getElementById('quick-add-expense-2').addEventListener('click', async () => {
  if (isProcessing) return;
  isProcessing = true;
  
  try {
    if (!currentUser) {
      openAuthModal('login');
      isProcessing = false;
      return;
    }
    
    const amount = Number(document.getElementById('quick-amount').value) || 0;
    const category_id = document.getElementById('quick-category').value || null;
    const card_id = document.getElementById('quick-card').value || null;
    
    if (!amount || !card_id || !category_id) {
      alert('–£–∫–∞–∂–∏ —Å—É–º–º—É, –∫–∞—Ä—Ç—É –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
      isProcessing = false;
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –∫–∞—Ä—Ç–µ
    const card = state.cards.find(c => c.id === card_id);
    if (card && amount > Number(card.balance || 0)) {
      if (!confirm(`–ù–∞ –∫–∞—Ä—Ç–µ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –ë–∞–ª–∞–Ω—Å: ${fmt(card.balance)}. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) {
        isProcessing = false;
        return;
      }
    }
    
    // –ë–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    await dbInsert('expenses', { 
      amount, 
      category_id, 
      card_id, 
      note: '–ë—ã—Å—Ç—Ä–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è', 
      created_at: new Date().toISOString() 
    });
    
    await loadDataFromSupabase(); 
    renderAll();
    document.getElementById('quick-amount').value='';
  } catch (err) {
    console.error('Error saving quick expense:', err);
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–∞: ' + err.message);
  } finally {
    isProcessing = false;
  }
});

document.getElementById('clear-expense').addEventListener('click', () => {
  document.getElementById('expense-amount').value=''; 
  document.getElementById('expense-note').value=''; 
});

// Filters
document.getElementById('apply-filters').addEventListener('click', () => {
  currentFilters.card_id = document.getElementById('filter-card').value || '';
  currentFilters.category_id = document.getElementById('filter-category').value || '';
  renderExpensesList();
});

document.getElementById('reset-filters').addEventListener('click', () => {
  currentFilters = { card_id:'', category_id:'' };
  document.getElementById('filter-card').value='';
  document.getElementById('filter-category').value='';
  renderExpensesList();
});

// Incomes (–Ω–æ–≤—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)
document.getElementById('form-add-income').addEventListener('submit', (e) => {
  e.preventDefault();
  document.getElementById('save-income').click();
});

document.getElementById('save-income').addEventListener('click', async () => {
  if (isProcessing) return;
  isProcessing = true;
  
  try {
    if (!currentUser) {
      openAuthModal('login');
      isProcessing = false;
      return;
    }
    
    const amount = Number(document.getElementById('income-amount').value) || 0;
    const category_id = document.getElementById('income-category').value || null;
    const card_id = document.getElementById('income-card').value || null;
    const note = document.getElementById('income-note').value.trim();
    
    if (!amount || !card_id || !category_id) {
      alert('–£–∫–∞–∂–∏ —Å—É–º–º—É, –∫–∞—Ä—Ç—É –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
      isProcessing = false;
      return;
    }
    
    // –ë–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—Å—è —á–µ—Ä–µ–∑ —Ç—Ä–∏–≥–≥–µ—Ä –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    await dbInsert('incomes', { 
      amount, 
      category_id, 
      card_id, 
      note, 
      created_at: new Date().toISOString() 
    });
    
    await loadDataFromSupabase(); 
    renderAll();
    document.getElementById('income-amount').value=''; 
    document.getElementById('income-note').value='';
    document.getElementById('income-category').value='';
    alert('–î–æ—Ö–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω');
  } catch (err) {
    console.error('Error saving income:', err);
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ—Ö–æ–¥–∞: ' + err.message);
  } finally {
    isProcessing = false;
  }
});

document.getElementById('clear-income').addEventListener('click', () => {
  document.getElementById('income-amount').value=''; 
  document.getElementById('income-note').value='';
  document.getElementById('income-category').value='';
});

// Income Filters
document.getElementById('apply-income-filters').addEventListener('click', () => {
  currentIncomeFilters.card_id = document.getElementById('filter-income-card').value || '';
  currentIncomeFilters.category_id = document.getElementById('filter-income-category').value || '';
  renderIncomesList();
});

document.getElementById('reset-income-filters').addEventListener('click', () => {
  currentIncomeFilters = { card_id:'', category_id:'' };
  document.getElementById('filter-income-card').value='';
  document.getElementById('filter-income-category').value='';
  renderIncomesList();
});

// Categories
document.getElementById('form-add-category').addEventListener('submit', (e) => {
  e.preventDefault();
  document.getElementById('save-category').click();
});

document.getElementById('save-category').addEventListener('click', async () => {
  if (isProcessing) return;
  isProcessing = true;
  
  try {
    if (!currentUser) {
      openAuthModal('login');
      isProcessing = false;
      return;
    }
    
    const name = document.getElementById('category-name').value.trim(); 
    if (!name) {
      alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏');
      isProcessing = false;
      return;
    }
    
    await dbInsert('categories', { name });
    await loadDataFromSupabase(); 
    renderAll(); 
    document.getElementById('category-name').value='';
  } catch (err) {
    console.error('Error saving category:', err);
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ' + err.message);
  } finally {
    isProcessing = false;
  }
});

// Payments
document.getElementById('form-add-payment').addEventListener('submit', (e) => {
  e.preventDefault();
  document.getElementById('save-payment').click();
});

document.getElementById('save-payment').addEventListener('click', async () => {
  if (isProcessing) return;
  isProcessing = true;
  
  try {
    if (!currentUser) {
      openAuthModal('login');
      isProcessing = false;
      return;
    }
    
    const editId = document.getElementById('save-payment').dataset.editId;
    const name = document.getElementById('payment-name').value.trim();
    const amount = Number(document.getElementById('payment-amount').value) || 0;
    const card_id = document.getElementById('payment-card').value || null;
    
    if (!name || !amount) {
      alert('–£–∫–∞–∂–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å—É–º–º—É');
      isProcessing = false;
      return;
    }
    
    if (editId) {
      await dbUpdate('payments', editId, { 
        name, 
        amount, 
        card_id 
      });
      delete document.getElementById('save-payment').dataset.editId;
      await loadDataFromSupabase(); 
      renderAll(); 
      alert('–ü–ª–∞—Ç—ë–∂ –æ–±–Ω–æ–≤–ª—ë–Ω');
    } else {
      await dbInsert('payments', { 
        name, 
        amount, 
        card_id, 
        paid: false 
      });
      await loadDataFromSupabase(); 
      renderAll(); 
      document.getElementById('payment-name').value=''; 
      document.getElementById('payment-amount').value=''; 
      document.getElementById('payment-card').value='';
    }
  } catch (err) {
    console.error('Error saving payment:', err);
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞: ' + err.message);
  } finally {
    isProcessing = false;
  }
});

document.getElementById('clear-payment').addEventListener('click', () => {
  document.getElementById('payment-name').value=''; 
  document.getElementById('payment-amount').value=''; 
  document.getElementById('payment-card').value=''; 
});

// Export / Import
document.getElementById('export-data').addEventListener('click', () => {
  const dump = { 
    user: currentUser ? currentUser.email : 'guest', 
    cards: state.cards, 
    categories: state.categories, 
    expenses: state.expenses, 
    incomes: state.incomes,  // ‚Üê –¥–æ–±–∞–≤–ª–µ–Ω–æ
    payments: state.payments, 
    exportedAt: new Date().toISOString() 
  };
  
  const blob = new Blob([JSON.stringify(dump,null,2)], { type:'application/json' }); 
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a'); 
  a.href = url; 
  a.download = `moneyflow-${currentUser ? currentUser.id : 'guest'}-data.json`; 
  a.click(); 
  
  URL.revokeObjectURL(url);
});

document.getElementById('import-data').addEventListener('click', async () => {
  if (!currentUser) {
    openAuthModal('login');
    return;
  }
  
  const input = document.createElement('input'); 
  input.type='file'; 
  input.accept='application/json';
  
  input.onchange = async () => {
    const file = input.files[0]; 
    if (!file) return; 
    
    const reader = new FileReader();
    reader.onload = async (evt) => { 
      try { 
        const parsed = JSON.parse(evt.target.result); 
        
        if (!confirm('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞? –≠—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).')) {
          return;
        }
        
        // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        for (const r of state.expenses) await dbDelete('expenses', r.id);
        for (const r of state.incomes) await dbDelete('incomes', r.id);
        for (const r of state.payments) await dbDelete('payments', r.id);
        for (const r of state.categories) await dbDelete('categories', r.id);
        for (const r of state.cards) await dbDelete('cards', r.id);
        
        // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        for (const c of parsed.cards || []) {
          await dbInsert('cards', { 
            name: c.name, 
            last4: c.last4, 
            balance: c.balance, 
            color: c.color || randomColor() 
          });
        }
        
        for (const cat of parsed.categories || []) {
          await dbInsert('categories', { name: cat.name });
        }
        
        for (const e of parsed.expenses || []) {
          await dbInsert('expenses', { 
            amount: e.amount, 
            category_id: e.category_id || null, 
            card_id: e.card_id || null, 
            note: e.note || '', 
            created_at: e.created_at || new Date().toISOString() 
          });
        }
        
        for (const i of parsed.incomes || []) {
          await dbInsert('incomes', { 
            amount: i.amount, 
            category_id: i.category_id || null, 
            card_id: i.card_id || null, 
            note: i.note || '', 
            created_at: i.created_at || new Date().toISOString() 
          });
        }
        
        for (const p of parsed.payments || []) {
          await dbInsert('payments', { 
            name: p.name, 
            amount: p.amount, 
            card_id: p.card_id || null, 
            paid: p.paid || false 
          });
        }
        
        await loadDataFromSupabase(); 
        renderAll(); 
        alert('–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω');
      } catch(e) { 
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª: ' + e.message); 
      } 
    };
    
    reader.readAsText(file);
  };
  
  input.click();
});

// Demo button
document.getElementById('add-sample-data').addEventListener('click', async () => {
  if (isProcessing) return;
  isProcessing = true;
  
  try {
    if (!currentUser) {
      openAuthModal('login');
      isProcessing = false;
      return;
    }
    
    if (!confirm('–î–æ–±–∞–≤–∏—Ç—å –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–µ–∫—É—â–∏–π –∞–∫–∫–∞—É–Ω—Ç?')) {
      isProcessing = false;
      return;
    }
    
    for (const c of demo.cards) {
      await dbInsert('cards', { 
        name: c.name, 
        last4: c.last4, 
        balance: c.balance, 
        color: c.color || randomColor() 
      });
    }
    
    for (const cat of demo.categories) {
      await dbInsert('categories', { name: cat.name });
    }
    
    await loadDataFromSupabase(); 
    renderAll();
  } catch (err) {
    console.error('Error adding demo data:', err);
    alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–µ–º–æ-–¥–∞–Ω–Ω—ã—Ö: ' + err.message);
  } finally {
    isProcessing = false;
  }
});

// Tabs
const tabs = ['dashboard','cards','expenses','categories','payments','incomes']; // ‚Üê –¥–æ–±–∞–≤–ª–µ–Ω–æ incomes
function showTab(name){
  tabs.forEach(t => {
    const isActive = t === name;
    document.getElementById('tab-'+t).classList.toggle('active', isActive);
    document.getElementById('tab-'+t+'-content').style.display = isActive ? 'block' : 'none';
  });
  
  const activeRegion = document.querySelector('[role="region"][style*="block"]');
  if (activeRegion) activeRegion.focus();
}

tabs.forEach(t => {
  document.getElementById('tab-'+t).addEventListener('click', () => showTab(t));
});

// –ö–Ω–æ–ø–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞
document.getElementById('quick-add-card').addEventListener('click', () => showTab('cards'));
document.getElementById('show-cards-tab').addEventListener('click', () => showTab('cards'));
document.getElementById('quick-add-expense').addEventListener('click', () => showTab('expenses'));
document.getElementById('open-expenses-tab').addEventListener('click', () => showTab('expenses'));
document.getElementById('quick-add-income').addEventListener('click', () => showTab('incomes')); // ‚Üê –¥–æ–±–∞–≤–ª–µ–Ω–æ

function renderAll(){ 
  populateSelects(); 
  renderSummary(); 
  renderCardsList(); 
  renderRecentExpenses(); 
  renderStats(); 
  renderExpensesList(); 
  renderCategories(); 
  renderPayments(); 
  renderIncomesList(); // ‚Üê –¥–æ–±–∞–≤–ª–µ–Ω–æ
  renderChart(); 
  renderUserArea(); 
}

// Initial load
(async () => {
  try {
    if (supabaseClient && supabaseClient.auth && typeof supabaseClient.auth.getSession === 'function'){
      const { data } = await supabaseClient.auth.getSession();
      currentUser = data?.session?.user || null;
      
      if (currentUser) {
        await loadDataFromSupabase();
        subscribeToUpdates();
      }
    } else {
      currentUser = null;
    }
  } catch(err) {
    console.warn('Supabase session check failed', err);
    currentUser = null;
  }
  
  renderAll();
})();

// UX helpers
document.addEventListener('keydown', (e) => {
  if (e.key === 'N' || e.key === 'n') showTab('expenses');
  if (e.key === 'C' || e.key === 'c') showTab('cards');
  if (e.key === 'D' || e.key === 'd') showTab('dashboard');
  if (e.key === 'I' || e.key === 'i') showTab('incomes'); // ‚Üê –¥–æ–±–∞–≤–ª–µ–Ω–æ
});

document.addEventListener('focusin', (e) => {
  if (e.target && e.target.matches('button,input,select,textarea')) {
    e.target.style.outline = '2px solid rgba(124,58,237,0.22)';
  }
});

document.addEventListener('focusout', (e) => {
  if (e.target && e.target.matches('button,input,select,textarea')) {
    e.target.style.outline = 'none';
  }
});

// Dev helper
window._moneyflow_clear_all = async function(){
  if (!confirm('–ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ MoneyFlow –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
  if (!currentUser) return alert('–ù—É–∂–µ–Ω –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
  
  isProcessing = true;
  
  try {
    // delete all rows for user
    await supabaseClient.from('expenses').delete().eq('user_id', currentUser.id);
    await supabaseClient.from('incomes').delete().eq('user_id', currentUser.id);
    await supabaseClient.from('payments').delete().eq('user_id', currentUser.id);
    await supabaseClient.from('categories').delete().eq('user_id', currentUser.id);
    await supabaseClient.from('cards').delete().eq('user_id', currentUser.id);
    await loadDataFromSupabase(); 
    renderAll(); 
    alert('–î–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã');
  } catch (err) {
    console.error('Error clearing data:', err);
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: ' + err.message);
  } finally {
    isProcessing = false;
  }
};

// ===== Supabase diagnostics =====
function appendDiag(msg){
  const el = document.getElementById('diag-log');
  const time = new Date().toLocaleTimeString();
  if (el) { 
    el.textContent = `${el.textContent}\n[${time}] ${msg}`; 
    el.scrollTop = el.scrollHeight; 
  }
  console.log('[diag]', msg);
}

async function diagnoseSupabase(){
  const scriptUrl = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js';
  appendDiag('Starting Supabase diagnostics...');

  // 1) check window.supabase
  if (!window.supabase){
    appendDiag('window.supabase: NOT FOUND');
  } else {
    appendDiag('window.supabase: present');
    appendDiag('createClient: ' + (typeof window.supabase.createClient === 'function' ? 'yes' : 'no'));
  }

  // 2) fetch the UMD script to inspect headers (CORS / content-type)
  try {
    appendDiag('Fetching UMD script to check availability and content-type...');
    const res = await fetch(scriptUrl, { method:'GET', mode:'cors' });
    appendDiag(`Fetch status: ${res.status} ${res.statusText}`);
    const ct = res.headers.get('content-type') || '‚Äî';
    appendDiag(`Content-Type: ${ct}`);
    if (!res.ok) appendDiag('Warning: script fetch returned non-OK status.');
    if (!ct.includes('javascript') && !ct.includes('application/javascript') && !ct.includes('text/javascript')){
      appendDiag('Warning: script Content-Type is not JavaScript; browser may refuse to execute (nosniff).');
    }
  } catch(err) {
    appendDiag('Fetch error: ' + (err.message || err));
  }

  // 3) try to init client (safely) and call getSession
  if (typeof window.supabase?.createClient === 'function'){
    try {
      appendDiag('Trying to init supabase client and call auth.getSession()...');
      const tmp = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      if (tmp && tmp.auth && typeof tmp.auth.getSession === 'function'){
        try {
          const { data } = await tmp.auth.getSession();
          appendDiag('auth.getSession() OK ‚Äî session present: ' + (data?.session ? 'yes' : 'no'));
        } catch(err) {
          appendDiag('auth.getSession() failed: ' + (err.message || err));
        }
      } else {
        appendDiag('Created client does not expose auth.getSession()');
      }
    } catch(err) {
      appendDiag('Error while creating client / calling API: ' + (err.message || err));
    }
  } else {
    appendDiag('createClient function not available ‚Äî cannot instantiate client.');
  }

  appendDiag('Diagnostics finished.');
}

// global error handlers to surface issues
window.addEventListener('error', (ev) => {
  appendDiag('Global error: ' + (ev.message || ev.error || ev.type || ev.filename || JSON.stringify(ev)));
});

window.addEventListener('unhandledrejection', (ev) => {
  appendDiag('Unhandled rejection: ' + (ev.reason?.message || JSON.stringify(ev.reason)));
});

// wire diag button
(function wireDiag(){
  const btn = document.getElementById('diag-supabase');
  if (!btn) return;
  btn.addEventListener('click', () => { 
    document.getElementById('diag-log').textContent = ''; 
    diagnoseSupabase(); 
  });
})();
  </script>
</body>
</html>
