<!doctype html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>MoneyFlow</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* =====================
   BASIC DARK UI
===================== */
:root {
  --bg:#0b0f14;
  --panel:#0f172a;
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --accent:#7c3aed;
}

* { box-sizing:border-box; }

body {
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui;
}

.app {
  display:grid;
  grid-template-columns:240px 1fr;
  min-height:100vh;
}

aside {
  background:#020617;
  padding:20px;
  border-right:1px solid var(--border);
}

main {
  padding:24px;
}

button,input,select {
  background:#020617;
  color:var(--text);
  border:1px solid var(--border);
  padding:10px;
  border-radius:8px;
}

button { cursor:pointer; }

.card {
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
}

nav button {
  width:100%;
  margin-bottom:8px;
}

/* Auth */
#auth {
  max-width:360px;
  margin:100px auto;
}
.hidden { display:none; }
</style>
</head>
<body>

<!-- AUTH -->
<div id="auth" class="card">
  <h2>MoneyFlow</h2>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="login()">–í–æ–π—Ç–∏ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
</div>

<!-- APP -->
<div id="app" class="app hidden">
  <aside>
    <h3>MoneyFlow</h3>
    <p id="userEmail" style="font-size:13px;color:var(--muted)"></p>

    <nav>
      <button onclick="showTab('dashboard')">üè† –î—ç—à–±–æ—Ä–¥</button>
      <button onclick="showTab('cards')">üí≥ –ö–∞—Ä—Ç—ã</button>
      <button onclick="showTab('expenses')">üßæ –†–∞—Å—Ö–æ–¥—ã</button>
      <button onclick="showTab('categories')">üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
      <button onclick="showTab('payments')">üìÖ –ü–ª–∞—Ç–µ–∂–∏</button>
    </nav>

    <button onclick="logout()">–í—ã–π—Ç–∏</button>
  </aside>

  <main>
    <!-- DASHBOARD -->
    <div id="dashboard" class="tab">
      <div class="card">
        <h3>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</h3>
        <h1 id="totalBalance">‚Äî</h1>
      </div>

      <div class="card">
        <canvas id="chart"></canvas>
      </div>
    </div>

    <!-- CARDS -->
    <div id="cards" class="tab hidden">
      <div class="card">
        <h3>–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É</h3>
        <input id="cardName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <input id="cardLast4" placeholder="–ü–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã">
        <input id="cardBalance" type="number" placeholder="–ë–∞–ª–∞–Ω—Å">
        <button onclick="addCard()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>

      <div id="cardsList"></div>
    </div>

    <!-- EXPENSES -->
    <div id="expenses" class="tab hidden">
      <div class="card">
        <h3>–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</h3>
        <input id="expenseAmount" type="number" placeholder="–°—É–º–º–∞">
        <select id="expenseCard"></select>
        <select id="expenseCategory"></select>
        <button onclick="addExpense()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>

      <div id="expensesList"></div>
    </div>

    <!-- CATEGORIES -->
    <div id="categories" class="tab hidden">
      <div class="card">
        <h3>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
        <input id="categoryName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <button onclick="addCategory()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div id="categoriesList"></div>
    </div>

    <!-- PAYMENTS -->
    <div id="payments" class="tab hidden">
      <div class="card">
        <h3>–ü–ª–∞—Ç–µ–∂–∏</h3>
        <input id="paymentName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <input id="paymentAmount" type="number" placeholder="–°—É–º–º–∞">
        <select id="paymentCard"></select>
        <button onclick="addPayment()">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
      <div id="paymentsList"></div>
    </div>
  </main>
</div>

<script>
/* =====================
   SUPABASE INIT
===================== */
const SUPABASE_URL = "https://tzsqgwupguttgsuhbknb.supabase.co"
const SUPABASE_KEY = "sb_publishable_nB-DBmdfeDkjqPLQeuSxrw_mE-p30aO"

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY)

/* =====================
   AUTH
===================== */
async function login() {
  const emailInput = document.getElementById("email")
  const passwordInput = document.getElementById("password")

  const email = emailInput.value.trim()
  const password = passwordInput.value.trim()

  if (!email || !password) {
    alert("–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å")
    return
  }

  // –ø—Ä–æ–±—É–µ–º –≤–æ–π—Ç–∏
  const { error } = await supabaseClient.auth.signInWithPassword({
    email,
    password
  })

  // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º
  if (error) {
    const { error: signUpError } = await supabaseClient.auth.signUp({
      email,
      password
    })

    if (signUpError) {
      alert(signUpError.message)
    }
  }
}


  let res = await supabaseClient.auth.signInWithPassword({ email, password })
  if (res.error) {
    await supabaseClient.auth.signUp({ email, password })
  }
}

async function logout() {
  await supabaseClient.auth.signOut()
}

supabaseClient.auth.onAuthStateChange((e, session) => {
  if (session) {
    auth.classList.add("hidden")
    app.classList.remove("hidden")
    userEmail.textContent = session.user.email
    loadAll()
  } else {
    auth.classList.remove("hidden")
    app.classList.add("hidden")
  }
})

/* =====================
   UI
===================== */
function showTab(id) {
  document.querySelectorAll(".tab").forEach(t => t.classList.add("hidden"))
  document.getElementById(id).classList.remove("hidden")
}

/* =====================
   DATA LOADERS
===================== */
async function loadAll() {
  await loadCards()
  await loadCategories()
  await loadExpenses()
  await loadPayments()
  renderChart()
}

/* =====================
   CARDS
===================== */
async function addCard() {
  const user = (await supabase.auth.getUser()).data.user
  await supabaseClient.from("cards").insert({
    user_id: user.id,
    name: cardName.value,
    last4: cardLast4.value,
    balance: Number(cardBalance.value)
  })
  loadCards()
}

async function loadCards() {
  const { data } = await supabaseClient.from("cards").select("*")
  cardsList.innerHTML = data.map(c =>
    `<div class="card">${c.name} ‚Äî ${c.balance}</div>`
  ).join("")
  expenseCard.innerHTML =
  paymentCard.innerHTML =
    data.map(c => `<option value="${c.id}">${c.name}</option>`).join("")
}

/* =====================
   CATEGORIES
===================== */
async function addCategory() {
  const user = (await supabaseClient.auth.getUser()).data.user
  await supabaseClient.from("categories").insert({
    user_id: user.id,
    name: categoryName.value
  })
  loadCategories()
}

async function loadCategories() {
  const { data } = await supabaseClient.from("categories").select("*")
  categoriesList.innerHTML = data.map(c =>
    `<div class="card">${c.name}</div>`
  ).join("")
  expenseCategory.innerHTML =
    data.map(c => `<option value="${c.id}">${c.name}</option>`).join("")
}

/* =====================
   EXPENSES
===================== */
async function addExpense() {
  const user = (await supabaseClient.auth.getUser()).data.user
  await supabaseClient.from("expenses").insert({
    user_id: user.id,
    amount: Number(expenseAmount.value),
    card_id: expenseCard.value,
    category_id: expenseCategory.value
  })
  loadExpenses()
}

async function loadExpenses() {
  const { data } = await supabaseClient.from("expenses").select("*, cards(name)")
  expensesList.innerHTML = data.map(e =>
    `<div class="card">${e.amount} ‚Äî ${e.cards.name}</div>`
  ).join("")
}

/* =====================
   PAYMENTS
===================== */
async function addPayment() {
  const user = (await supabaseClient.auth.getUser()).data.user
  await supabaseCliente.from("payments").insert({
    user_id: user.id,
    name: paymentName.value,
    amount: Number(paymentAmount.value),
    card_id: paymentCard.value
  })
  loadPayments()
}

async function loadPayments() {
  const { data } = await supabaseClient.from("payments").select("*")
  paymentsList.innerHTML = data.map(p =>
    `<div class="card">${p.name} ‚Äî ${p.amount}</div>`
  ).join("")
}

/* =====================
   CHART
===================== */
async function renderChart() {
  const { data } = await supabaseClient.from("expenses").select("amount, categories(name)")
  const map = {}
  data.forEach(e => {
    const n = e.categories?.name || "–î—Ä—É–≥–æ–µ"
    map[n] = (map[n] || 0) + e.amount
  })

  new Chart(chart, {
    type: "pie",
    data: {
      labels: Object.keys(map),
      datasets: [{ data: Object.values(map) }]
    }
  })
}
</script>
</body>
</html>
