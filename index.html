<!-- BLOCK 1: <!doctype html> + <head> -->
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MoneyFlow ‚Äî —É—á—ë—Ç –ª–∏—á–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤ (—Å –∞–∫–∫–∞—É–Ω—Ç–æ–º)</title>

  <!-- Chart.js —á–µ—Ä–µ–∑ CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    /* ===========================
       –¢—ë–º–Ω–∞—è –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è —Ç–µ–º–∞
       =========================== */
    :root{
      --bg: #0b0f14;
      --panel: #0f1720;
      --muted: #98a0aa;
      --accent: linear-gradient(135deg,#7c3aed,#06b6d4);
      --glass: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.02);
      --glass-3: rgba(255,255,255,0.04);
      --card-shadow: 0 6px 18px rgba(2,6,23,0.6);
      --radius: 14px;
      --radius-sm: 10px;
      --trans: 220ms cubic-bezier(.2,.9,.3,1);
      --currency: "‚ÇΩ";
    }

    html,body{ height:100%; margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:
      radial-gradient(1200px 600px at 10% 10%, rgba(124,58,237,0.06), transparent 6%),
      radial-gradient(1200px 600px at 90% 90%, rgba(6,182,212,0.04), transparent 6%),
      var(--bg);
      color:#e6eef6; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    .app{ max-width:1100px; margin:32px auto; padding:28px; display:grid; grid-template-columns: 260px 1fr; gap:20px; align-items:start; }

    /* Sidebar */
    .sidebar{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:var(--radius); padding:16px; box-shadow: var(--card-shadow); min-height:520px; position:sticky; top:20px; }
    .brand{ display:flex; gap:12px; align-items:center; margin-bottom:18px; }
    .logo{ width:44px; height:44px; border-radius:10px; background:var(--accent); display:flex; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(124,58,237,0.12); font-weight:700; }
    .brand h1{ font-size:16px; margin:0; }
    .brand p{ margin:0; color:var(--muted); font-size:12px; }

    nav ul{ list-style:none; padding:0; margin:12px 0; display:flex; flex-direction:column; gap:8px; }
    nav button{ display:flex; gap:12px; align-items:center; width:100%; background:transparent; border:0; color:inherit; padding:10px 12px; border-radius:10px; cursor:pointer; transition:all var(--trans); text-align:left; }
    nav button:hover{ background:var(--glass-2); transform:translateY(-2px); }
    nav button.active{ background:linear-gradient(90deg, rgba(124,58,237,0.12), rgba(6,182,212,0.04)); box-shadow:0 6px 18px rgba(2,6,23,0.6); }

    .sidebar .section-title{ color:var(--muted); font-size:12px; margin:14px 2px 4px; }
    .small{ font-size:12px; color:var(--muted); }

    /* Main area */
    .main{ min-height:520px; display:flex; flex-direction:column; gap:18px; }

    .summary{ display:flex; gap:16px; align-items:center; }
    .card{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:var(--radius); padding:18px; box-shadow: var(--card-shadow); }
    .summary .total{ flex:1; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .quick-actions{ display:flex; gap:10px; }
    .btn{ background: linear-gradient(90deg,#2b3141,#16181c); border:0; padding:8px 12px; border-radius:10px; cursor:pointer; color:#e6eef6; font-weight:600; box-shadow: 0 6px 18px rgba(2,6,23,0.35); transition: transform var(--trans), box-shadow var(--trans); }
    .btn:active{ transform:translateY(1px); }

    .grid{ display:grid; grid-template-columns: 380px 1fr; gap:16px; align-items:start; }

    .chart-wrap{ padding:14px; border-radius:var(--radius-sm); background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01)); }
    canvas{ display:block; max-width:100%; height:260px !important; }

    .cards-list{ display:flex; flex-direction:column; gap:12px; margin-top:6px; }
    .bank-card{ display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:12px; background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); transition: transform var(--trans), box-shadow var(--trans); }
    .bank-card:hover{ transform:translateY(-4px); box-shadow: 0 14px 30px rgba(2,6,23,0.6); }
    .bank-card .meta{ display:flex; gap:12px; align-items:center; }
    .chip{ width:44px; height:44px; border-radius:10px; display:grid; place-items:center; background:linear-gradient(135deg,#1f2937,#111827); font-weight:700; color:var(--muted); }
    .small-muted{ color:var(--muted); font-size:12px; }

    .list{ display:flex; flex-direction:column; gap:8px; }
    .list-item{ display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:10px; background:var(--glass); transition:all var(--trans); }

    .form{ display:flex; flex-direction:column; gap:10px; margin-top:8px; }
    .form-row{ display:flex; gap:8px; }
    input[type="text"], input[type="number"], select, input[type="password"]{ background:transparent; border:1px solid rgba(255,255,255,0.06); padding:10px 12px; border-radius:10px; color:inherit; outline:none; flex:1; transition:border-color var(--trans); }
    input[type="text"]:focus, input[type="number"]:focus, select:focus, input[type="password"]:focus{ border-color:rgba(124,58,237,0.6); box-shadow:0 6px 18px rgba(124,58,237,0.06); }

    .payments{ display:flex; flex-direction:column; gap:8px; margin-top:8px; }
    .payment-row{ display:flex; gap:12px; align-items:center; justify-content:space-between; padding:10px; border-radius:10px; background:var(--glass-3); }

    .pill{ padding:6px 8px; border-radius:999px; background:rgba(255,255,255,0.03); font-size:13px; color:var(--muted); }

    .footer{ color:var(--muted); font-size:12px; margin-top:8px; }
    .muted{ color:var(--muted); font-size:13px; }

    /* Auth modal */
    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal{ width:380px; border-radius:12px; padding:18px; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow: 0 20px 60px rgba(2,6,23,0.7); }
    .tabs{ display:flex; gap:8px; margin-bottom:12px; }
    .tabs button{ flex:1; padding:8px; border-radius:8px; border:0; background:transparent; color:var(--muted); cursor:pointer; }
    .tabs button.active{ background:rgba(124,58,237,0.12); color:#eaf2ff; }

    /* Responsive */
    @media (max-width:980px){
      .app{ grid-template-columns: 1fr; padding:14px; }
      .summary{ flex-direction:column; }
      .grid{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; top:auto; min-height:auto; }
    }
  </style>
</head>
<!-- END BLOCK 1 -->
<!-- BLOCK 2: <body> –¥–æ –∫–æ–Ω—Ü–∞ sidebar -->
<body>
  <div class="app" id="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è">
      <div class="brand">
        <div class="logo">MF</div>
        <div>
          <h1>MoneyFlow</h1>
          <p>–£—á—ë—Ç –ª–∏—á–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤ ‚Äî —Ç—ë–º–Ω–∞—è —Ç–µ–º–∞</p>
        </div>
      </div>

      <!-- USER AREA -->
      <div id="user-area" style="margin-bottom:12px;">
        <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è —á–µ—Ä–µ–∑ JS: —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è / –∫–Ω–æ–ø–∫–∏ -->
      </div>

      <nav aria-label="–ú–µ–Ω—é">
        <ul>
          <li><button id="tab-dashboard" class="active" data-tab="dashboard">üè† –î—ç—à–±–æ—Ä–¥</button></li>
          <li><button id="tab-cards" data-tab="cards">üí≥ –ö–∞—Ä—Ç—ã</button></li>
          <li><button id="tab-expenses" data-tab="expenses">üßæ –†–∞—Å—Ö–æ–¥—ã</button></li>
          <li><button id="tab-categories" data-tab="categories">üè∑Ô∏è –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button></li>
          <li><button id="tab-payments" data-tab="payments">üìÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã</button></li>
        </ul>
      </nav>

      <div class="section-title">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
      <div style="display:flex;gap:8px;margin-top:8px;">
        <button class="btn" id="quick-add-card">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É</button>
        <button class="btn" id="quick-add-expense">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
      </div>

      <div style="margin-top:18px;">
        <div class="small">
          –ü–æ—Å–ª–µ–¥–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:
          <span class="small-muted" id="last-sync">‚Äî</span>
        </div>
        <div class="footer">
          Supabase ¬∑ Postgres ¬∑ RLS
        </div>
      </div>
    </aside>
<!-- END BLOCK 2 -->
<!-- BLOCK 3: main layout + tabs -->
    <!-- MAIN -->
    <main class="main">
      <!-- Top summary -->
      <div class="summary">
        <div class="card total" style="min-width:320px;">
          <div class="left">
            <h2>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</h2>
            <p id="total-balance">‚Äî</p>
            <div class="muted" id="accounts-count">‚Äî –∫–∞—Ä—Ç</div>
          </div>
          <div class="quick-actions">
            <button class="btn" id="export-data" title="–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ">–≠–∫—Å–ø–æ—Ä—Ç</button>
            <button class="btn" id="import-data" title="–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JSON">–ò–º–ø–æ—Ä—Ç</button>
          </div>
        </div>

        <div style="display:flex;gap:12px; align-items:center;">
          <div class="card" style="min-width:220px;">
            <div class="muted">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</div>
            <div id="recent-list" style="margin-top:8px;"></div>
          </div>
        </div>
      </div>

      <!-- Content area (tabs) -->
      <section id="content-area">
        <!-- DASHBOARD -->
        <div id="tab-dashboard-content" class="card" role="region" tabindex="-1">
          <h3 style="margin:0 0 12px 0;">–î–∞—à–±–æ—Ä–¥</h3>
          <div class="grid">
            <div>
              <div class="chart-wrap card">
                <h4 style="margin:0 0 10px 0;">–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</h4>
                <canvas id="expensesChart"></canvas>
                <div class="muted" style="margin-top:8px;">
                  –î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—É–º–º–∞—Ä–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º.
                </div>
              </div>

              <div style="margin-top:12px;" class="card">
                <h4 style="margin:0 0 8px 0;">–ö–∞—Ä—Ç—ã</h4>
                <div class="cards-list" id="cards-list"></div>
                <div style="margin-top:10px; display:flex; gap:8px;">
                  <button class="btn" id="show-cards-tab">–£–ø—Ä–∞–≤–ª—è—Ç—å –∫–∞—Ä—Ç–∞–º–∏</button>
                  <button class="btn" id="add-sample-data">–î–æ–±–∞–≤–∏—Ç—å demo-–¥–∞–Ω–Ω—ã–µ</button>
                </div>
              </div>
            </div>

            <div>
              <div class="card">
                <h4 style="margin:0 0 8px 0;">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                <div class="list" id="stats-list"></div>
              </div>

              <div class="card" style="margin-top:12px;">
                <h4 style="margin:0 0 8px 0;">–ù–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</h4>
                <div class="form">
                  <input type="number" id="quick-amount" placeholder="–°—É–º–º–∞" />
                  <select id="quick-category"></select>
                  <select id="quick-card"></select>
                  <div style="display:flex; gap:8px;">
                    <button class="btn" id="quick-add-expense-2">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</button>
                    <button class="btn" id="open-expenses-tab">–û—Ç–∫—Ä—ã—Ç—å —Ä–∞—Å—Ö–æ–¥—ã</button>
                  </div>
                  <div class="muted">
                    –ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤—å —Ä–∞—Å—Ö–æ–¥ ‚Äî –±–∞–ª–∞–Ω—Å –∫–∞—Ä—Ç—ã —É–º–µ–Ω—å—à–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CARDS -->
        <div id="tab-cards-content" class="card" role="region" style="display:none;" tabindex="-1">
          <h3 style="margin:0 0 12px 0;">–ö–∞—Ä—Ç—ã</h3>
          <div class="grid" style="grid-template-columns:1fr 360px;">
            <div>
              <div class="list" id="cards-manage-list"></div>
            </div>
            <div>
              <div class="card">
                <h4 style="margin:0 0 8px 0;">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É</h4>
                <form id="form-add-card" class="form" onsubmit="return false;">
                  <input id="card-name" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required />
                  <input id="card-last4" type="text" placeholder="–ü–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã" />
                  <input id="card-balance" type="number" placeholder="–ë–∞–ª–∞–Ω—Å" step="0.01" required />
                  <div style="display:flex; gap:8px;">
                    <button class="btn" id="save-card">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn" id="reset-cards">–°–±—Ä–æ—Å–∏—Ç—å demo</button>
                  </div>
                  <div class="muted">–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ Supabase</div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- EXPENSES -->
        <div id="tab-expenses-content" class="card" role="region" style="display:none;" tabindex="-1">
          <h3 style="margin:0 0 12px 0;">–†–∞—Å—Ö–æ–¥—ã</h3>
          <div style="display:flex; gap:16px;">
            <div style="flex:1;">
              <div class="card">
                <h4 style="margin:0 0 8px 0;">–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥</h4>
                <form id="form-add-expense" class="form" onsubmit="return false;">
                  <input id="expense-amount" type="number" step="0.01" placeholder="–°—É–º–º–∞" required />
                  <select id="expense-category" required></select>
                  <select id="expense-card" required></select>
                  <input id="expense-note" type="text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" />
                  <div style="display:flex; gap:8px;">
                    <button class="btn" id="save-expense">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button class="btn" id="clear-expense">–û—á–∏—Å—Ç–∏—Ç—å</button>
                  </div>
                </form>
              </div>

              <div class="card" style="margin-top:12px;">
                <h4 style="margin:0 0 8px 0;">–ò—Å—Ç–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤</h4>
                <div id="expenses-list" class="list"></div>
              </div>
            </div>

            <div style="width:360px;">
              <div class="card">
                <h4 style="margin:0 0 8px 0;">–§–∏–ª—å—Ç—Ä—ã</h4>
                <div class="form">
                  <select id="filter-card"></select>
                  <select id="filter-category"></select>
                  <div style="display:flex; gap:8px;">
                    <button class="btn" id="apply-filters">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    <button class="btn" id="reset-filters">–°–±—Ä–æ—Å</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CATEGORIES -->
        <div id="tab-categories-content" class="card" role="region" style="display:none;" tabindex="-1">
          <h3 style="margin:0 0 12px 0;">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h3>
          <div style="display:flex; gap:16px;">
            <div style="flex:1;">
              <div class="card">
                <h4 style="margin:0 0 8px 0;">–°–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h4>
                <div id="categories-list" class="list"></div>
              </div>
            </div>
            <div style="width:360px;">
              <div class="card">
                <h4 style="margin:0 0 8px 0;">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h4>
                <form id="form-add-category" class="form" onsubmit="return false;">
                  <input id="category-name" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" required />
                  <div style="display:flex; gap:8px;">
                    <button class="btn" id="save-category">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button class="btn" id="reset-categories">–°–±—Ä–æ—Å</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

        <!-- PAYMENTS -->
        <div id="tab-payments-content" class="card" role="region" style="display:none;" tabindex="-1">
          <h3 style="margin:0 0 12px 0;">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏</h3>
          <div style="display:flex; gap:16px;">
            <div style="flex:1;">
              <div class="payments" id="payments-list"></div>
            </div>
            <div style="width:360px;">
              <div class="card">
                <h4 style="margin:0 0 8px 0;">–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂</h4>
                <form id="form-add-payment" class="form" onsubmit="return false;">
                  <input id="payment-name" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required />
                  <input id="payment-amount" type="number" step="0.01" placeholder="–°—É–º–º–∞" required />
                  <select id="payment-card" required></select>
                  <div style="display:flex; gap:8px;">
                    <button class="btn" id="save-payment">–î–æ–±–∞–≤–∏—Ç—å</button>
                    <button class="btn" id="clear-payment">–û—á–∏—Å—Ç–∏—Ç—å</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>

      </section>
    </main>
  </div>
<!-- END BLOCK 3 -->
<!-- BLOCK 4: auth modal -->
  <!-- AUTH MODAL -->
  <div class="overlay" id="auth-overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="auth-title">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 id="auth-title" style="margin:0;">–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h3>
        <button class="btn" id="close-auth">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <div class="tabs" style="margin-top:12px;">
        <button id="tab-auth-login" class="active">–í—Ö–æ–¥</button>
        <button id="tab-auth-signup">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>

      <!-- LOGIN -->
      <div id="auth-login">
        <form id="form-login" class="form" onsubmit="return false;">
          <input id="login-email" type="email" placeholder="Email" required />
          <input id="login-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required />
          <div style="display:flex;gap:8px;">
            <button class="btn" id="btn-login">–í–æ–π—Ç–∏</button>
            <button class="btn" id="btn-login-guest">–ì–æ—Å—Ç—å (demo)</button>
          </div>
          <div class="muted">
            –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Supabase Auth (email + password)
          </div>
        </form>
      </div>

      <!-- SIGNUP -->
      <div id="auth-signup" style="display:none;">
        <form id="form-signup" class="form" onsubmit="return false;">
          <input id="signup-email" type="email" placeholder="Email" required />
          <input id="signup-password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" required />
          <input id="signup-password2" type="password" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required />
          <div style="display:flex;gap:8px;">
            <button class="btn" id="btn-signup">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            <button class="btn" id="btn-cancel-signup">–û—Ç–º–µ–Ω–∞</button>
          </div>
          <div class="muted">
            –ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è –≤ Supabase Auth
          </div>
        </form>
      </div>
    </div>
  </div>
<!-- END BLOCK 4 -->
<!-- BLOCK 5: JavaScript ‚Äî Supabase init + authService -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/* ===========================
   Supabase init
   =========================== */
const SUPABASE_URL = 'https://tzsqgwupguttgsuhbknb.supabase.co';
const SUPABASE_ANON_KEY = 'sb_publishable_nB-DBmdfeDkjqPLQeuSxrw_mE-p30aO';

const supabase = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY
);


/* ===========================
   App state
   =========================== */
let currentUser = null; // supabase user or null (guest)
let state = {
  cards: [],
  categories: [],
  expenses: [],
  payments: []
};

/* ===========================
   Auth service
   =========================== */
const authService = {
  async init() {
    const { data } = await supabase.auth.getUser();
    currentUser = data?.user ?? null;
  },

  async login(email, password) {
    const { error } = await supabase.auth.signInWithPassword({
      email,
      password
    });
    if (error) throw error;
    await this.init();
  },

  async signup(email, password) {
    const { error } = await supabase.auth.signUp({
      email,
      password
    });
    if (error) throw error;
    await this.init();
  },

  async logout() {
    await supabase.auth.signOut();
    currentUser = null;
  },

  isGuest() {
    return !currentUser;
  },

  userId() {
    return currentUser?.id ?? null;
  }
};
</script>
<!-- END BLOCK 5 -->
<!-- BLOCK 6: JavaScript ‚Äî dataService (Supabase CRUD) -->
<script>
/* ===========================
   dataService
   =========================== */
const dataService = {
  async loadAll() {
    if (!currentUser) {
      // guest / demo
      state.cards = [];
      state.categories = [];
      state.expenses = [];
      state.payments = [];
      return;
    }

    const userId = authService.userId();

    const [cards, categories, expenses, payments] = await Promise.all([
      supabase.from('cards').select('*').eq('user_id', userId),
      supabase.from('categories').select('*').eq('user_id', userId),
      supabase.from('expenses').select('*').eq('user_id', userId),
      supabase.from('payments').select('*').eq('user_id', userId)
    ]);

    if (cards.error) throw cards.error;
    if (categories.error) throw categories.error;
    if (expenses.error) throw expenses.error;
    if (payments.error) throw payments.error;

    state.cards = cards.data || [];
    state.categories = categories.data || [];
    state.expenses = expenses.data || [];
    state.payments = payments.data || [];
  },

  /* ---- Cards ---- */
  async saveCard(card) {
    card.user_id = authService.userId();
    const { error } = await supabase.from('cards').upsert(card);
    if (error) throw error;
  },

  async deleteCard(id) {
    const { error } = await supabase.from('cards').delete().eq('id', id);
    if (error) throw error;
  },

  /* ---- Categories ---- */
  async saveCategory(cat) {
    cat.user_id = authService.userId();
    const { error } = await supabase.from('categories').upsert(cat);
    if (error) throw error;
  },

  async deleteCategory(id) {
    const { error } = await supabase.from('categories').delete().eq('id', id);
    if (error) throw error;
  },

  /* ---- Expenses ---- */
  async saveExpense(exp) {
    exp.user_id = authService.userId();
    const { error } = await supabase.from('expenses').upsert(exp);
    if (error) throw error;
  },

  async deleteExpense(id) {
    const { error } = await supabase.from('expenses').delete().eq('id', id);
    if (error) throw error;
  },

  /* ---- Payments ---- */
  async savePayment(p) {
    p.user_id = authService.userId();
    const { error } = await supabase.from('payments').upsert(p);
    if (error) throw error;
  },

  async deletePayment(id) {
    const { error } = await supabase.from('payments').delete().eq('id', id);
    if (error) throw error;
  }
};
</script>
<!-- END BLOCK 6 -->
<!-- BLOCK 7: JavaScript ‚Äî UI logic (auth + data sync hooks) -->
<script>
/* ===========================
   Auth modal UI
   =========================== */
const authOverlay = document.getElementById('auth-overlay');
const authLoginTab = document.getElementById('tab-auth-login');
const authSignupTab = document.getElementById('tab-auth-signup');
const authLoginPane = document.getElementById('auth-login');
const authSignupPane = document.getElementById('auth-signup');

function openAuth(tab='login'){
  authOverlay.style.display = 'flex';
  if (tab === 'signup'){
    authLoginTab.classList.remove('active');
    authSignupTab.classList.add('active');
    authLoginPane.style.display='none';
    authSignupPane.style.display='block';
  } else {
    authLoginTab.classList.add('active');
    authSignupTab.classList.remove('active');
    authLoginPane.style.display='block';
    authSignupPane.style.display='none';
  }
}
function closeAuth(){
  authOverlay.style.display = 'none';
}

document.getElementById('close-auth').onclick = closeAuth;
document.getElementById('btn-cancel-signup').onclick = closeAuth;
authLoginTab.onclick = ()=>openAuth('login');
authSignupTab.onclick = ()=>openAuth('signup');

/* ===========================
   Auth actions
   =========================== */
document.getElementById('btn-login').onclick = async ()=>{
  try{
    await authService.login(
      document.getElementById('login-email').value,
      document.getElementById('login-password').value
    );
    closeAuth();
    await dataService.loadAll();
    renderAll();
  }catch(e){ alert(e.message); }
};

document.getElementById('btn-signup').onclick = async ()=>{
  const p1 = signup-password.value;
  const p2 = signup-password2.value;
  if (p1 !== p2) return alert('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
  try{
    await authService.signup(
      document.getElementById('signup-email').value,
      p1
    );
    closeAuth();
    await dataService.loadAll();
    renderAll();
  }catch(e){ alert(e.message); }
};

document.getElementById('btn-login-guest').onclick = ()=>{
  currentUser = null;
  state = { cards:[], categories:[], expenses:[], payments:[] };
  closeAuth();
  renderAll();
};

/* ===========================
   User area render
   =========================== */
function renderUserArea(){
  const area = document.getElementById('user-area');
  area.innerHTML = '';

  if (currentUser){
    area.innerHTML = `
      <div>
        <div style="font-weight:700">${currentUser.email}</div>
        <button class="btn" id="btn-logout-small">–í—ã–π—Ç–∏</button>
      </div>
    `;
    document.getElementById('btn-logout-small').onclick = async ()=>{
      await authService.logout();
      state = { cards:[], categories:[], expenses:[], payments:[] };
      renderAll();
    };
  } else {
    area.innerHTML = `
      <div>
        <div style="font-weight:700">–ì–æ—Å—Ç—å</div>
        <button class="btn" id="btn-open-login">–í–æ–π—Ç–∏</button>
      </div>
    `;
    document.getElementById('btn-open-login').onclick = ()=>openAuth('login');
  }
}
</script>
<!-- END BLOCK 7 -->
<!-- BLOCK 8: JavaScript ‚Äî renderAll + bootstrapping -->
<script>
/* ===========================
   Boot
   =========================== */
async function boot(){
  await authService.init();
  await dataService.loadAll();
  renderAll();
}

/* ===========================
   renderAll (UI unchanged)
   =========================== */
function renderAll(){
  renderUserArea();
  populateSelects();
  renderSummary();
  renderCardsList();
  renderRecentExpenses();
  renderStats();
  renderExpensesList();
  renderCategories();
  renderPayments();
  renderChart();
}

boot();
</script>
</body>
</html>
<!-- END BLOCK 8 -->
